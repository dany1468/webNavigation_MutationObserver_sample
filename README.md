# コンテンツが動的に変更されるページにおいて、エレメントをどう補足するか

Yammer を題材にして、Chrome extension でアクションボタンに新しいボタンを追加したいとした時、どうやって動的にリフレッシュされる画面に対して、追随していくか。

Yammer は一度ロードされると、単なるスクロール時の追加ロードだけでなく、グループ等を移動しても更新されるのは中央エリアだけである。

## hashchange イベントで画面の更新を補足する

残念ながら hashchange イベントは、「DOMの変更前」に発生するため意味が無かった

## webNavigation イベントで画面の更新を補足する

初回読み込みでの動的なコンテンツの読み込みでは各種イベントが発火したものの、その後のグループの移動では、`onReferenceFragmentUpdated` が発生するのみで hashchange と大差なかった。

> 今回は試さなかったが webRequest API を利用すれば、少なくともグループ変更時にサーバーにコンテンツの読み込みを問い合わせて、そのレスポンスを受け取るところまでは補足できた気がする。
> ただ、Yammer は一度読み込んだエレメントは画面でキャッシュしているようなので、一度見たグループに再度移動した時に対処できない。

## MutationObserver で対象のエレメントの追加を関しする

Yammer は中央エリアが入れ替わる形式なので、別の方法も試してみたが、結果としては `MutationObserver` が一番やりやすそう。というか、コレ以外だと補足しきれないものが出てきてしまう。

## Message Passing のコードが入っているのは

webNavigation API は Content scripts では利用できないので、Event Page で補足して通知するしかなかったのでその実験。
Content scripts に送るには、tab API を経由しないといけないのにハマった。でも、そりゃそうですよね。

hashchange でメッセージを送っているのは何も意味は無い。
